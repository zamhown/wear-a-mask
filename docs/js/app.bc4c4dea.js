(function(t){function e(e){for(var n,r,s=e[0],h=e[1],c=e[2],l=0,u=[];l<s.length;l++)r=s[l],Object.prototype.hasOwnProperty.call(a,r)&&a[r]&&u.push(a[r][0]),a[r]=0;for(n in h)Object.prototype.hasOwnProperty.call(h,n)&&(t[n]=h[n]);d&&d(e);while(u.length)u.shift()();return o.push.apply(o,c||[]),i()}function i(){for(var t,e=0;e<o.length;e++){for(var i=o[e],n=!0,s=1;s<i.length;s++){var h=i[s];0!==a[h]&&(n=!1)}n&&(o.splice(e--,1),t=r(r.s=i[0]))}return t}var n={},a={app:0},o=[];function r(e){if(n[e])return n[e].exports;var i=n[e]={i:e,l:!1,exports:{}};return t[e].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.m=t,r.c=n,r.d=function(t,e,i){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},r.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"===typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)r.d(i,n,function(e){return t[e]}.bind(null,n));return i},r.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="/wear-a-mask/";var s=window["webpackJsonp"]=window["webpackJsonp"]||[],h=s.push.bind(s);s.push=e,s=s.slice();for(var c=0;c<s.length;c++)e(s[c]);var d=h;o.push([0,"chunk-vendors"]),i()})({0:function(t,e,i){t.exports=i("56d7")},"034f":function(t,e,i){"use strict";var n=i("85ec"),a=i.n(n);a.a},1:function(t,e){},2:function(t,e){},3:function(t,e){},"4d24":function(t,e,i){t.exports=i.p+"img/logo-title.02b87219.svg"},"56d7":function(t,e,i){"use strict";i.r(e);i("e260"),i("e6cf"),i("cca6"),i("a79d");var n=i("2b0e"),a=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{attrs:{id:"app"}},[t._m(0),i("div",{attrs:{id:"contentContainer"}},[i("div",{attrs:{id:"content"}},[i("Index",{directives:[{name:"show",rawName:"v-show",value:"index"==t.nav,expression:"nav=='index'"}],on:{navTo:t.navTo}}),i("Editor",{directives:[{name:"show",rawName:"v-show",value:"editor"==t.nav,expression:"nav=='editor'"}],attrs:{fileId:t.currentFileId},on:{navTo:t.navTo}}),"export"==t.nav?i("Export",{on:{navTo:t.navTo}}):t._e()],1)])])},o=[function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{attrs:{id:"header"}},[n("img",{attrs:{id:"logo",src:i("4d24")}}),n("a",{attrs:{id:"forkMe",href:"https://github.com/zamhown/wear-a-mask"}},[t._v("Fork me on GitHub!")])])}],r=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{ref:"index"},[t._m(0),i("p",{staticClass:"title"},[t._v("疫情当前，有罩才稳")]),i("p",{staticClass:"slogan"},[t.wide?t._e():i("span",{domProps:{innerHTML:t._s(t.space)}}),t._v("给社交网络头像戴上口罩，"),t.wide?t._e():i("br"),t.wide?t._e():i("span",{domProps:{innerHTML:t._s(t.space)}}),t._v("提醒更多人关注身体健康。")]),i("div",{staticClass:"upload"},[i("span",[t._v("选择图片")]),i("input",{ref:"inputer",staticClass:"upload",attrs:{type:"file",accept:"image/*"},on:{change:t.addImg}})]),i("p",{staticClass:"description"},[t._v("此页面可以在你的头像上自动P上口罩，你还可以对口罩的位置和大小进行编辑。")]),i("p",{staticClass:"description"},[t._v("人脸检测算法基于SSD MobileNet V1神经网络模型，无需上传图片，也不会保留任何数据。")])])},s=[function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("p",[n("img",{staticClass:"example",attrs:{src:i("96e3")}})])}],h={data:function(){return{space:"　",wide:!1}},methods:{addImg:function(){var t=this.$refs.inputer;if(1==t.files.length){var e={file:t.files[0],id:(new Date).getTime()};this.$store.commit("setUserImgInfo",e),this.$emit("navTo","editor",e.id)}}},mounted:function(){this.wide=this.$refs.index.clientWidth>500}},c=h,d=(i("ebf2"),i("2877")),l=Object(d["a"])(c,r,s,!1,null,"410321b3",null),u=l.exports,g=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{ref:"editor",attrs:{id:"editor"}},[i("div",{class:{loading:t.loading},attrs:{id:"editorUI"}},[i("div",{ref:"canvasContainer"}),i("button",{attrs:{id:"resumeBtn"},on:{click:t.resumeMask}},[t._v("重置")]),i("div",{ref:"maskStore",attrs:{id:"maskStore"}},[i("p",{staticClass:"title"},[t._v("更换口罩")]),i("div",{staticClass:"list"},[i("ul",t._l(t.maskData.masks,(function(e){return i("li",{key:e.name,on:{click:function(i){return t.changeMask(e)}}},[i("img",{attrs:{src:t.maskData.baseUrl+e.name}})])})),0)])]),i("div",{ref:"control",staticClass:"control"},[i("button",{attrs:{id:"reuploadBtn"},on:{click:t.reupload}},[t._v("重选图片")]),i("button",{attrs:{id:"saveBtn"},on:{click:t.save}},[t._v("保存图片")])])]),t.loading?i("div",{attrs:{id:"loading"}},[t._m(0)]):t._e()])},f=[function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("p",[i("b",[t._v("正在进行人脸检测，请稍等……")]),i("br"),t._v(" 由于算法全程在浏览器运行， "),i("br"),t._v(" 运算速度可能取决于设备性能。 ")])])}],m=(i("a9e3"),i("4160"),i("d3b7"),i("3ca3"),i("159b"),i("ddb0"),i("96cf"),i("1da1")),v=i("ab39"),p=(i("4de4"),i("b0c0"),i("2af1"),i("2b3d"),i("3835")),w={maskBaseUrl:"https://zamhown.github.io/wear-a-mask/masks/",modelBaseUrl:"https://zamhown.github.io/wear-a-mask/weights"},P={baseUrl:w.maskBaseUrl,masks:[{name:"n1.png",width:256,height:256,side:0,leftPoint:[4,90],rightPoint:[248,90],bottomPoint:[130,216]},{name:"n2.png",width:256,height:256,side:0,leftPoint:[3,71],rightPoint:[255,71],bottomPoint:[129,231]},{name:"n3.png",width:256,height:256,side:0,leftPoint:[6,81],rightPoint:[249,81],bottomPoint:[131,246]},{name:"n4.png",width:256,height:256,side:0,leftPoint:[4,69],rightPoint:[252,69],bottomPoint:[137,234]},{name:"n5.png",width:256,height:256,side:0,leftPoint:[13,47],rightPoint:[248,47],bottomPoint:[163,222]},{name:"n6.png",width:256,height:256,side:0,leftPoint:[7,56],rightPoint:[251,56],bottomPoint:[108,243]},{name:"n7.png",width:256,height:256,side:0,leftPoint:[7,78],rightPoint:[247,78],bottomPoint:[123,230]},{name:"n8.png",width:256,height:256,side:0,leftPoint:[17,77],rightPoint:[248,77],bottomPoint:[131,250]},{name:"n9.png",width:256,height:256,side:0,leftPoint:[61,156],rightPoint:[223,156],bottomPoint:[137,247]},{name:"n10.png",width:256,height:256,side:1,leftPoint:[8,100],rightPoint:[225,100],bottomPoint:[92,240]},{name:"n11.png",width:256,height:256,side:1,leftPoint:[37,86],rightPoint:[221,86],bottomPoint:[80,243]},{name:"n12.png",width:256,height:256,side:0,leftPoint:[8,65],rightPoint:[250,65],bottomPoint:[127,242]},{name:"n13.png",width:256,height:256,side:0,leftPoint:[10,86],rightPoint:[249,86],bottomPoint:[126,244]},{name:"n14.png",width:256,height:256,side:0,leftPoint:[10,97],rightPoint:[246,97],bottomPoint:[122,210]},{name:"n15.png",width:256,height:256,side:2,leftPoint:[3,63],rightPoint:[209,63],bottomPoint:[143,241]},{name:"n16.png",width:256,height:256,side:0,leftPoint:[11,88],rightPoint:[240,88],bottomPoint:[123,210]},{name:"n17.png",width:256,height:256,side:0,leftPoint:[9,59],rightPoint:[236,59],bottomPoint:[95,248]},{name:"n18.png",width:256,height:256,side:0,leftPoint:[13,93],rightPoint:[244,93],bottomPoint:[133,226]},{name:"n19.png",width:256,height:256,side:0,leftPoint:[15,45],rightPoint:[247,45],bottomPoint:[165,247]},{name:"n20.png",width:256,height:256,side:0,leftPoint:[8,77],rightPoint:[246,77],bottomPoint:[127,242]},{name:"n21.png",width:256,height:256,side:0,leftPoint:[11,65],rightPoint:[246,65],bottomPoint:[129,251]},{name:"n22.png",width:256,height:256,side:0,leftPoint:[31,107],rightPoint:[215,107],bottomPoint:[123,232]},{name:"n23.png",width:256,height:256,side:0,leftPoint:[19,93],rightPoint:[239,93],bottomPoint:[125,232]},{name:"n24.png",width:256,height:256,side:0,leftPoint:[19,72],rightPoint:[242,72],bottomPoint:[154,251]}]},b={getMidPoint:function(t,e){var i=Object(p["a"])(t,2),n=i[0],a=i[1],o=Object(p["a"])(e,2),r=o[0],s=o[1];return[(n+r)/2,(a+s)/2]},makeLine:function(t,e){var i=Object(p["a"])(t,2),n=i[0],a=i[1],o=Object(p["a"])(e,2),r=o[0],s=o[1];return[a-s,r-n,(n-r)*s+(s-a)*r]},pointDistance:function(t,e){var i=Object(p["a"])(t,2),n=i[0],a=i[1],o=Object(p["a"])(e,2),r=o[0],s=o[1];return Math.sqrt((n-r)*(n-r)+(a-s)*(a-s))},pointLineDistance:function(t,e){var i=Object(p["a"])(t,2),n=i[0],a=i[1],o=Object(p["a"])(e,3),r=o[0],s=o[1],h=o[2];return Math.abs(r*n+s*a+h)/Math.sqrt(r*r+s*s)},makePerpendicularLine:function(t,e){var i=Object(p["a"])(t,2),n=i[0],a=i[1],o=Object(p["a"])(e,2),r=o[0],s=o[1];return[-a,n,a*r-n*s]},getCrossPointOfTwoLines:function(t,e){var i=Object(p["a"])(t,3),n=i[0],a=i[1],o=i[2],r=Object(p["a"])(e,3),s=r[0],h=r[1],c=r[2],d=n*h-s*a;return[(a*c-h*o)/d,(s*o-n*c)/d]},getPerpendicularPoint:function(t,e){return this.getCrossPointOfTwoLines(t,this.makePerpendicularLine(t,e))},getAngle:function(t,e,i){var n=Object(p["a"])(t,2),a=n[0],o=n[1],r=Object(p["a"])(e,2),s=r[0],h=r[1],c=Object(p["a"])(i,2),d=c[0],l=c[1],u=s-a,g=o-h,f=d-a,m=o-l,v=Math.sqrt(u*u+g*g)*Math.sqrt(f*f+m*m);if(0===v)return-1;var w=Math.acos((u*f+g*m)/v),P=a-d,b=o-l;return P<0&&b<0?w:P<0&&b>0?w:P>0&&b<0?2*Math.PI-w:P>0&&b>0?2*Math.PI-w:null}},k=i("af87");function M(t){return[t.x,t.y]}var y={maskImageSrc:{},findMask:function(t,e,i,n){var a=this,o=Number.MAX_VALUE,r=null;return P.masks.filter((function(t){return 0==t.side&&0==n||t.side*n>0})).forEach((function(s){var h=b.pointDistance(s.leftPoint,s.rightPoint),c=b.pointDistance(s.leftPoint,s.bottomPoint),d=b.pointLineDistance(s.bottomPoint,b.makeLine(s.leftPoint,s.rightPoint)),l=Math.sqrt(c*c-d*d),u=l/h,g=Object(p["a"])(t,2),f=g[0],m=g[1],v=Object(p["a"])(e,2),w=v[0],P=v[1];if(0==s.side&&0==n||s.side==n){var M=f+(w-f)*u,y=m+(P-m)*u,I=b.makePerpendicularLine(b.makeLine(t,e),[M,y]),L=b.pointLineDistance(i,I);o>L&&(o=L,r=k["Object"].assign({overturn:!1,transform:a.computeTransform(s.leftPoint,s.rightPoint,s.bottomPoint,t,e,b.getPerpendicularPoint(I,i),s.width,s.height)},s))}if(0==s.side&&0==n||s.side!=n){var _=w+(f-w)*u,x=P+(m-P)*u,O=b.makePerpendicularLine(b.makeLine(t,e),[_,x]),j=b.pointLineDistance(i,O);o>j&&(o=j,r=k["Object"].assign({overturn:!0,transform:a.computeTransform([s.width-s.leftPoint[0],s.leftPoint[1]],[s.width-s.rightPoint[0],s.rightPoint[1]],[s.width-s.bottomPoint[0],s.bottomPoint[1]],t,e,b.getPerpendicularPoint(O,i),s.width,s.height)},s))}})),r},computeTransform:function(t,e,i,n,a,o,r,s){var h=b.pointDistance(n,a),c=h/b.pointDistance(t,e),d=b.pointLineDistance(o,b.makeLine(n,a))/b.pointLineDistance(i,b.makeLine(t,e));return{xScale:c,yScale:d,centerX:(r/2-t[0])*c+n[0],centerY:(s/2-t[1])*c+n[1],angle:b.getAngle(n,[n[0]+h*Math.sign(a[0]-n[0]),n[1]],a)}},wearAMaskAfterFaceDetection:function(t,e,i){var n=t.landmarks.positions,a=b.getMidPoint(M(n[1]),M(n[2])),o=b.getMidPoint(M(n[15]),M(n[14])),r=M(n[8]),s=M(n[28]),h=0;s.x>o.x?(o=s,h=2):s.x<a.x&&(a=s,h=1);var c={mask:this.findMask(a,o,r,h),imgOriginalWidth:t.detection.imageWidth,imgOriginalHeight:t.detection.imageHeight};return this.wearAMaskNormally(c,e,i)},wearAMaskNormally:function(t,e,i){var n=t.mask,a=i.width/t.imgOriginalWidth,o=i.height/t.imgOriginalHeight,r=n.width*n.transform.xScale*(n.overturn?-1:1)*a;return this.getMaskImageSrc(n,(function(t){e.layers.length>1&&e.removeItem(1),e.addPhoto(t,{width:r,height:n.height*n.transform.yScale*o,centerX:n.transform.centerX*a+i.position[0]-(n.overturn?r:0),centerY:n.transform.centerY*o+i.position[1],angle:n.transform.angle},!0),e.chooseItem(1)})),t},wearAMaskAsAFool:function(t,e){var i=P.masks[2];return this.getMaskImageSrc(i,(function(i){t.layers.length>1&&t.removeItem(1),t.addPhoto(i,{width:e.width/4,height:e.height/4,centerX:t.width/2,centerY:t.height/2,angle:0},!0),t.chooseItem(1)})),{mask:i}},resumeMask:function(t,e,i){t.imgOriginalWidth?this.wearAMaskNormally(t,e,i):this.wearAMaskAsAFool(e,i)},changeMask:function(t,e){var i=e.layers[1].rect;e.removeItem(1),this.getMaskImageSrc(t,(function(t){e.addPhoto(t,{width:i.width,height:i.height,centerX:i.center[0],centerY:i.center[1],angle:i.angle},!0),e.chooseItem(1)}))},getMaskImageSrc:function(t,e){if(this.maskImageSrc[t.name])e(this.maskImageSrc[t.name]);else{var i=this,n=new XMLHttpRequest;n.onload=function(){var n=URL.createObjectURL(this.response);i.maskImageSrc[t.name]=n,e(n)},n.open("GET",P.baseUrl+t.name,!0),n.responseType="blob",n.send()}}},I=w.modelBaseUrl,L={modelsLoaded:!1,modelsLoading:!1,onModelsLoaded:null,onModelsLoadErr:null,loadModels:function(){var t=this;if(!this.modelsLoading&&!this.modelsLoaded){var e=!1,i=function(){e=!0};Promise.all([v["c"].faceLandmark68Net.loadFromUri(I).catch(i),v["c"].faceLandmark68Net.loadFromUri(I).catch(i),v["c"].ssdMobilenetv1.loadFromUri(I).catch(i)]).then(Object(m["a"])(regeneratorRuntime.mark((function i(){return regeneratorRuntime.wrap((function(i){while(1)switch(i.prev=i.next){case 0:t.modelsLoading=!1,t.modelsLoaded=!e,!e&&t.onModelsLoaded?(t.onModelsLoaded(),t.onModelsLoaded=null):e&&t.onModelsLoadErr&&(t.onModelsLoadErr(),t.onModelsLoadErr=null);case 3:case"end":return i.stop()}}),i)}))))}},detectPic:function(t,e,i,n,a){var o=function(){var o=Object(m["a"])(regeneratorRuntime.mark((function o(){var r,s,h;return regeneratorRuntime.wrap((function(o){while(1)switch(o.prev=o.next){case 0:return r=new v["a"]({minConfidence:.2}),o.next=3,v["b"](t,r).withFaceLandmarks();case 3:s=o.sent,console.log(s),s?(h=y.wearAMaskAfterFaceDetection(s,e,i),n&&n(h)):a&&a("no result");case 6:case"end":return o.stop()}}),o)})));return function(){return o.apply(this,arguments)}}(),r=function(){a&&a("no result")};this.modelsLoading?(this.onModelsLoaded=o,this.onModelsLoadErr=r):this.modelsLoaded?o():(this.onModelsLoaded=o,this.onModelsLoadErr=r,this.loadModels())},drawFaceLandmarks:function(t,e,i){var n=t.getContext("2d");e.forEach((function(t){var e=i.width/t.detection.imageWidth,a=i.height/t.detection.imageHeight;t.landmarks.positions.forEach((function(t,o){var r=t.x*e+i.position[0],s=t.y*a+i.position[1];n.fillStyle="#0000FF",n.fillRect(r-2,s-2,4,4),n.font="12px bold 宋体",n.fillText(o,r,s)}))}))}},_=(i("99af"),i("cb29"),i("d81d"),i("13d5"),i("a434"),i("d4ec")),x=i("bee2"),O=function(t,e){var i=Object(p["a"])(t,2),n=i[0],a=i[1],o=Object(p["a"])(e,2),r=o[0],s=o[1];return(n*r+a*s)/Math.sqrt(n*n+a*a)},j=function(t){var e=t;"string"===typeof t&&(e=document.querySelector(e));var i=e.offsetLeft,n=e.offsetTop,a=e.offsetParent;while(a)i+=a.offsetLeft,n+=a.offsetTop,a=a.offsetParent;return{x:i,y:n}},E=function(){function t(e){Object(_["a"])(this,t),this.canvas=e}return Object(x["a"])(t,[{key:"refresh",value:function(t){var e=this;this.rect=t,this.points=this.rect.points,this.cPoints=[],this.points.reduce((function(t,i){return e.cPoints.push([(t[0]+i[0])/2,(t[1]+i[1])/2]),i}),this.points[3]),t.height>=0?this.rPoint=[(this.points[0][0]+this.points[1][0])/2,this.points[0][1]-35]:this.rPoint=[(this.points[2][0]+this.points[3][0])/2,this.points[0][1]+35],this.draw()}},{key:"draw",value:function(){var t=this.rect,e=t.points,i=t.center,n=t.angle,a=t.width,o=t.height,r=this.canvas.context,s=Object(p["a"])(i,2),h=s[0],c=s[1];r.save(),r.translate(h,c),r.rotate(n),r.beginPath(),r.globalAlpha=.5,r.lineWidth="3",r.strokeStyle="#FF9999",r.rect(e[0][0]-h,e[0][1]-c,a,o),r.moveTo((e[0][0]+e[1][0])/2-h,e[0][1]-c),r.lineTo(this.rPoint[0]-h,this.rPoint[1]-c),r.stroke(),r.closePath(),r.globalAlpha=1;var d=e.concat(this.cPoints);d.forEach((function(t){var e=Object(p["a"])(t,2),i=e[0],n=e[1];r.fillStyle="#FF4949",r.fillRect(i-7-h,n-7-c,14,14)})),d.push(this.rPoint),r.beginPath(),r.strokeStyle="#FF4949",r.fillStyle="#FF9999",r.lineWidth="5",r.arc(this.rPoint[0]-h,this.rPoint[1]-c,8,0,2*Math.PI,!0),r.stroke(),r.closePath(),r.fill(),r.restore()}},{key:"isPointInSkeletion",value:function(t){var e=this,i=null,n=Object(p["a"])(t,2),a=n[0],o=n[1],r=this.rect.angle,s=this.rect.rotatePoint(this.rPoint,r),h=this.points.map((function(t){return e.rect.rotatePoint(t,r)})),c=this.cPoints.map((function(t){return e.rect.rotatePoint(t,r)}));return function(){var t=Object(p["a"])(s,2),e=t[0],n=t[1];Math.sqrt(Math.pow(e-a,2)+Math.pow(n-o,2))<10&&(i="r_point")}(),h.forEach((function(t,e){var n=Object(p["a"])(t,2),r=n[0],s=n[1];Math.sqrt(Math.pow(r-a,2)+Math.pow(s-o,2))<10&&(i="point_".concat(e+1))})),c.forEach((function(t,e){var n=Object(p["a"])(t,2),r=n[0],s=n[1];Math.sqrt(Math.pow(r-a,2)+Math.pow(s-o,2))<10&&(i="c_point_".concat(e+1))})),i}}]),t}(),T=function(){function t(e,i,n,a){Object(_["a"])(this,t),this.height=i,this.width=e,this.center=n,this.angle=a,this.getPoints()}return Object(x["a"])(t,[{key:"getPoints",value:function(){var t=this.height,e=this.width,i=Object(p["a"])(this.center,2),n=i[0],a=i[1],o=[];o[0]=[n-e/2,a-t/2],o[1]=[n+e/2,a-t/2],o[2]=[n+e/2,a+t/2],o[3]=[n-e/2,a+t/2],this.points=o}},{key:"rotate",value:function(t){this.angle=t*Math.sign(this.height)}},{key:"translate",value:function(t){var e=Object(p["a"])(t,2),i=e[0],n=e[1],a=this.points.map((function(t){return[t[0]+i,t[1]+n]}));this.points=a,this.getCenter()}},{key:"zoom",value:function(t,e){var i=this,n=parseFloat(e[0]),a=parseFloat(e[1]),o=this.angle,r=Math.sin(o+Math.PI/2),s=Math.cos(o+Math.PI/2);0===o&&(r=1,s=0);var h=O([r,s],[n,-a]),c=5*Math.sin(o),d=5*Math.cos(o),l=O([c,d],[n,-a]),u=Math.atan(this.height/this.width),g=function(t){var e=O([-Math.cos(t),Math.sin(t)],[n,-a]);i.width+=e*Math.cos(u),i.height+=e*Math.sin(u),i.center=[i.center[0]-e*Math.cos(t)/2,i.center[1]-e*Math.sin(t)/2]};if("point_1"===t){var f=u+o;g(f)}else if("point_2"===t){var m=Math.PI-u+o;g(m)}else if("point_3"===t){var v=Math.PI+u+o;g(v)}else if("point_4"===t){var p=2*Math.PI-u+o;g(p)}else"c_point_1"===t?(this.width-=h,this.center=[this.center[0]+h*Math.cos(o)/2,this.center[1]+h*Math.sin(o)/2]):"c_point_2"===t?(this.height+=l,this.center=[this.center[0]+l*Math.sin(o)/2,this.center[1]-l*Math.cos(o)/2]):"c_point_3"===t?(this.width+=h,this.center=[this.center[0]+h*Math.cos(o)/2,this.center[1]+h*Math.sin(o)/2]):"c_point_4"===t&&(this.height-=l,this.center=[this.center[0]+l*Math.sin(o)/2,this.center[1]-l*Math.cos(o)/2]);this.getPoints()}},{key:"isPointInRect",value:function(t){var e=this,i=this.points.map((function(t){return e.rotatePoint(t,e.angle)})),n=i[0],a=i[1],o=i[2],r=i[3],s=t[0],h=-t[1],c=function(){var t=(n[1]-a[1])/(a[0]-n[0]),e=-n[1]-t*n[0],i=-o[1]-t*o[0];return e>i&&t*s+e>h&&t*s+i<h||e<i&&t*s+e<h&&t*s+i>h}(),d=function(){var t=(a[1]-o[1])/(o[0]-a[0]),e=-a[1]-t*a[0],i=-r[1]-t*r[0];return o[0]-a[0]===0&&(n[0]<s&&s<a[0]||n[0]>s&&s>a[0])||(e>i&&t*s+e>h&&t*s+i<h||e<i&&t*s+e<h&&t*s+i>h)}();return!(!c||!d)}},{key:"getCenter",value:function(){var t=this.points[0],e=this.points[2],i=t[0]+e[0],n=t[1]+e[1];this.center=[i/2,n/2]}},{key:"rotatePoint",value:function(t,e){var i=Object(p["a"])(t,2),n=i[0],a=i[1],o=Object(p["a"])(this.center,2),r=o[0],s=o[1],h=(n-r)*Math.cos(e)-(a-s)*Math.sin(e)+r,c=(n-r)*Math.sin(e)+(a-s)*Math.cos(e)+s;return[h,c]}},{key:"setWH",value:function(){this.height=Math.abs(this.points[0][1]-this.points[3][1]),this.width=Math.abs(this.points[0][0]-this.points[1][0])}}]),t}(),$=function(){function t(e,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];Object(_["a"])(this,t),this.canvas=i,this.imgInput=e,this.image=null,this.onLoad=n,this.rect=a,this.canEdit=o,this.id=(new Date).getTime(),this.isLoad=!1,e instanceof t?(this.options=e,this.imgInput=this.options.imgInput,this.id=this.options.id):e instanceof Image&&(this.image=e),this.prepare()}return Object(x["a"])(t,[{key:"prepare",value:function(){var t=this;"string"===typeof this.imgInput?(this.image=new Image,this.image.onload=function(){t.isLoad||(t.isLoad=!0,t.init())},this.image.src=this.imgInput,this.image.complete&&(this.isLoad=!0,this.init())):this.image?(this.isLoad=!0,this.init()):(this.image=this.imgInput,this.isLoad=!0,this.init())}},{key:"init",value:function(){if(this.onLoad&&this.onLoad(),!this.rect)if(this.options){var t=this.options.rect,e=t.width,i=t.height,n=t.center,a=t.angle;this.rect=new T(e,i,[n[0],n[1]],a)}else this.rect=new T(this.image.width,this.image.height,[this.canvas.width/2,this.canvas.height/2],0)}},{key:"draw",value:function(){var t=this.image,e=this.canvas,i=this.rect,n=e.context,a=i.points,o=Object(p["a"])(i.center,2),r=o[0],s=o[1];n.save(),n.translate(r,s),n.rotate(i.angle),n.scale(Math.sign(i.width),Math.sign(i.height)),n.drawImage(t,0,0,t.width,t.height,a[0][0]-r,a[0][1]-s,i.width,i.height),n.restore()}}]),t}(),C=function(){function t(e){Object(_["a"])(this,t),this.options=e;var i=this.options,n=i.canvas,a=i.height,o=i.width,r=i.target,s=i.beforeLoading,h=i.afterLoading,c=i.data,d=void 0===c?[]:c;this.canvas=null,this.height=a,this.width=o,this.target=r,this.beforeLoading=s,this.afterLoading=h,this.data=d,this.layers=[],this.canvas="string"===typeof n?document.getElementById(n):n,this.target="string"===typeof r?document.getElementById(r):r,this.canvas.width=o,this.canvas.height=a,this.context=this.canvas.getContext("2d"),this.loadingLayerCount=0,this.border=new E(this),this.current=null,this.init(),this.initEvent()}return Object(x["a"])(t,[{key:"init",value:function(){var t=this;this.clear(),this.beforeLoading&&this.beforeLoading(this);var e=function(e){t.loadingLayerCount+=1;var i=new $(e,t,(function(){setTimeout((function(){t.loadingLayerCount-=1,t.loadingLayerCount<1&&t.draw()}),100)}),e.rect,e.canEdit);t.layers.push(i)};this.data.forEach((function(t){"function"!==typeof t&&e(t)})),this.afterLoading&&this.afterLoading(this)}},{key:"initEvent",value:function(){var e=this;this.target.addEventListener("mousedown",(function(i){var n=i.pageX,a=i.pageY,o=j(e.target),r=e.width/e.target.offsetWidth,s=[(n-o.x)*r,(a-o.y)*r],h=e.selectPhoto(s);if(h){var c=function(i){var s=i.pageX,c=i.pageY,d=[(s-n)*r,(c-a)*r];if(1===h)e.current.rect.translate(d);else if("r_point"===h){var l=[(s-o.x)*r,(c-o.y)*r],u=t.getAngle(e.current.rect.center,e.border.rPoint,l);if(isNaN(u))return;e.current.rect.rotate(u)}else e.current.rect.zoom(h,d);e.draw(),n=s,a=c};e.target.addEventListener("mousemove",c),e.target.addEventListener("mouseup",(function(){e.target.removeEventListener("mousemove",c)}))}})),this.target.addEventListener("touchstart",(function(i){i.preventDefault();var n=i.touches[0].pageX,a=i.touches[0].pageY,o=j(e.target),r=e.width/e.target.offsetWidth,s=[(n-o.x)*r,(a-o.y)*r],h=e.selectPhoto(s);if(h){var c=function(i){var s=i.touches[0].pageX,c=i.touches[0].pageY,d=[(s-n)*r,(c-a)*r];if(1===h)e.current.rect.translate(d);else if("r_point"===h){var l=[(s-o.x)*r,(c-o.y)*r],u=t.getAngle(e.current.rect.center,e.border.rPoint,l);if(isNaN(u))return;e.current.rect.rotate(u)}else e.current.rect.zoom(h,d);e.draw(),n=s,a=c};e.target.addEventListener("touchmove",c),e.target.addEventListener("touchend",(function(){e.target.removeEventListener("touchmove",c)}))}}))}},{key:"addCommand",value:function(t){var e=this;this.layers.push(t),this.loadingLayerCount>0?setTimeout((function(){e.draw()}),100):this.draw()}},{key:"addPhoto",value:function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],a=null;if(i&&(a=new T(i.width,i.height,[i.centerX,i.centerY],i.angle)),"string"===typeof t){this.loadingLayerCount+=1;var o=new $(t,this,(function(){setTimeout((function(){e.loadingLayerCount-=1,e.loadingLayerCount<1&&e.draw()}),100)}),a,n);this.layers.push(o)}else{var r=new $(t,this,null,a,n);this.layers.push(r),this.draw()}}},{key:"selectPhoto",value:function(t){var e=this;if(this.current){var i=this.border.isPointInSkeletion(t);if(i)return i}var n=[].concat(this.layers).reverse();this.current=null;var a=0;return n.forEach((function(i,n){"function"!==typeof i&&!e.current&&i.rect.isPointInRect(t)&&i.canEdit&&(e.current=i,a=n+1)})),this.current?(this.chooseItem(this.layers.length-a),1):(this.draw(),0)}},{key:"chooseItem",value:function(t){this.layers[t].canEdit&&(this.current=this.layers[t],this.layers.splice(t,1),this.layers.push(this.current),this.draw())}},{key:"removeItem",value:function(t){this.layers.splice(t,1),this.draw()}},{key:"export",value:function(){var t=document.createElement("canvas"),e=this.layers[0];t.width=e.image.width,t.height=e.image.height;var i=t.getContext("2d");i.drawImage(e.image,0,0,e.image.width,e.image.height,0,0,t.width,t.height);var n=e.image.width/e.rect.width,a=e.image.height/e.rect.height,o=e.rect.center[0]-e.rect.width/2,r=e.rect.center[1]-e.rect.height/2;if(this.layers[1]){var s=this.layers[1],h=s.rect.points,c=Object(p["a"])(s.rect.center,2),d=c[0],l=c[1];d=(d-o)*n,l=(l-r)*a,i.save(),i.translate(d,l),i.rotate(s.rect.angle),i.scale(Math.sign(s.rect.width),Math.sign(s.rect.height)),i.drawImage(s.image,0,0,s.image.width,s.image.height,(h[0][0]-o)*n-d,(h[0][1]-r)*a-l,s.rect.width*n,s.rect.height*a),i.restore()}return t.toDataURL("image/png")}},{key:"clear",value:function(){this.context.save(),this.context.setTransform(1,0,0,1,0,0),this.context.clearRect(0,0,this.width,this.height),this.context.restore()}},{key:"save",value:function(){var t=this.layers.map((function(t){var e=t.rect,i=t.id,n=t.img;return{rect:e,id:i,img:n}}));return t}},{key:"draw",value:function(){var t=this;this.clear(),this.layers.forEach((function(e){"function"===typeof e?e.apply(null,t.context,t.canvas):e.draw()})),this.current&&this.border.refresh(this.current.rect)}}],[{key:"getAngle",value:function(t,e,i){var n=e[0]-t[0],a=t[1]-e[1],o=i[0]-t[0],r=t[1]-i[1],s=Math.sqrt(n*n+a*a)*Math.sqrt(o*o+r*r);if(0===s)return-1;var h=Math.acos((n*o+a*r)/s);return t[0]-i[0]<0&&t[1]-i[1]<0?h:t[0]-i[0]<0&&t[1]-i[1]>0?h:t[0]-i[0]>0&&t[1]-i[1]<0?2*Math.PI-h:t[0]-i[0]>0&&t[1]-i[1]>0?2*Math.PI-h:null}}]),t}(),S=C,F={props:{fileId:Number},data:function(){return{currentFileId:0,editor:null,canvas:null,maskData:P,maskInfo:null,realImgInfo:null,loading:!1}},methods:{loadImg:function(t){this.canvas&&this.canvas.remove(),this.canvas=document.createElement("canvas"),this.canvas.width=this.$refs.editor.clientWidth,this.canvas.height=this.$refs.editor.clientHeight-this.$refs.maskStore.clientHeight-this.$refs.control.clientHeight,this.$refs.canvasContainer.appendChild(this.canvas),this.editor=new S({canvas:this.canvas,target:this.canvas,width:this.canvas.width,height:this.canvas.height});var e=this.editor,i=this,n=new FileReader;n.readAsDataURL(t),n.onload=function(){var t=new Image;t.src=this.result,t.onload=function(){var n=e.width/t.width,a=e.height/t.height,o=n<a?n:a,r=t.width*o,s=t.height*o,h=(e.width-r)/2,c=(e.height-s)/2;e.addPhoto(t,{width:r,height:s,centerX:e.width/2,centerY:e.height/2,angle:0},!1),i.realImgInfo={width:r,height:s,position:[h,c]},i.loading=!0,setTimeout((function(){L.detectPic(t,e,i.realImgInfo,(function(t){i.maskInfo=t,i.loading=!1}),(function(t){console.log(t),i.maskInfo=y.wearAMaskAsAFool(i.editor,i.realImgInfo),i.loading=!1}))}),300)}}},resumeMask:function(){this.maskInfo&&this.editor&&y.resumeMask(this.maskInfo,this.editor,this.realImgInfo)},changeMask:function(t){this.maskInfo&&this.editor&&y.changeMask(t,this.editor)},reupload:function(){this.$emit("navTo","index")},save:function(){this.$store.commit("setEditor",this.editor),this.$emit("navTo","export")}},watch:{fileId:function(t){t!=this.currentFileId&&this.$store.state.userImgInfo&&t==this.$store.state.userImgInfo.id&&(this.loadImg(this.$store.state.userImgInfo.file),this.currentFileId=t)}}},A=F,U=(i("7029"),Object(d["a"])(A,g,f,!1,null,"29c9a076",null)),D=U.exports,H=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{attrs:{id:"export"}},[i("div",{class:{loading:t.loading},attrs:{id:"exportUI"}},[i("p",{ref:"ic",staticClass:"img-container"},[i("img",{style:t.imgStyle,attrs:{src:t.imgUrl},on:{load:t.onImgLoaded}})]),i("div",{ref:"title",staticClass:"title"},[i("p",[t._v("长按或右键保存下方图片")]),i("div",{staticClass:"control"},[i("button",{on:{click:t.backToEditor}},[t._v("继续编辑")]),i("button",{on:{click:t.backToIndex}},[t._v("重选图片")])])])]),t.loading?i("div",{attrs:{id:"loading"}},[t._m(0)]):t._e()])},R=[function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("p",[i("b",[t._v("正在导出中……")])])])}],N={data:function(){return{imgUrl:"",imgStyle:{},loading:!0}},methods:{onImgLoaded:function(){console.log(this.imgUrl),this.imgUrl&&(this.loading=!1)},backToIndex:function(){this.$emit("navTo","index")},backToEditor:function(){this.$emit("navTo","editor")}},created:function(){this.$store.state.editor||this.$emit("navTo","index")},mounted:function(){var t=this,e=this.$refs.ic.clientWidth,i=this.$refs.ic.clientHeight-this.$refs.title.clientHeight,n=this.$store.state.editor.layers[0].image.width,a=this.$store.state.editor.layers[0].image.height,o=e/n,r=i/a,s=o<r?o:r,h=n*s,c=a*s,d=(e-h)/2,l=(i-c)/2+this.$refs.title.clientHeight;this.imgStyle={width:h+"px",height:c+"px",left:d+"px",top:l+"px"},setTimeout((function(){t.imgUrl=t.$store.state.editor.export()}),300)}},q=N,W=(i("9d47"),Object(d["a"])(q,H,R,!1,null,"1bbda0a3",null)),X=W.exports,Y={name:"app",components:{Index:u,Editor:D,Export:X},data:function(){return{nav:"index",currentFileId:0}},methods:{navTo:function(t,e){this.nav=t,e&&(this.currentFileId=e)}}},B=Y,z=(i("034f"),Object(d["a"])(B,a,o,!1,null,null,null)),G=z.exports,J=i("2f62");n["a"].use(J["a"]);var V={userImgInfo:null,editor:null},K={},Q={},Z={setUserImgInfo:function(t,e){t.userImgInfo=e},setEditor:function(t,e){t.editor=e}},tt=new J["a"].Store({state:V,getters:K,actions:Q,mutations:Z});L.loadModels(),n["a"].config.productionTip=!1,new n["a"]({store:tt,render:function(t){return t(G)}}).$mount("#app")},7029:function(t,e,i){"use strict";var n=i("d3bf"),a=i.n(n);a.a},"85ec":function(t,e,i){},"8ee5":function(t,e,i){},"96e3":function(t,e,i){t.exports=i.p+"img/example.bcb76468.png"},"9d47":function(t,e,i){"use strict";var n=i("ccff"),a=i.n(n);a.a},ccff:function(t,e,i){},d3bf:function(t,e,i){},ebf2:function(t,e,i){"use strict";var n=i("8ee5"),a=i.n(n);a.a}});
//# sourceMappingURL=app.bc4c4dea.js.map